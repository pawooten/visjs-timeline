<!DOCTYPE html>
<html>
    <head><title>Sample Timeline</title></head>
    <style type="text/css">
        body, html {
        font-family: sans-serif;
        margin:0px;
        padding:0px;
        }
        #visualization
        {
            position:absolute;
            height:100%;
            width:100%;
        }
    </style>
    <script src="../../node_modules/vis/dist/vis.js"></script>
    <link href="../../node_modules/vis/dist/vis.css" rel="stylesheet" type="text/css" />
    <script src="../../node_modules/jquery/dist/jquery.js"></script>
    <body>
        <div id="visualization"></div>

        <script type="text/javascript">
        // DOM element where the Timeline will be attached
        var container = document.getElementById('visualization');

        var groups = [
            { id: 'Tab1', content: 'All' },
            { id: 'Tab2', content: 'Pathology' },
            { id: 'Tab3', content: 'Physician Notes' },
            { id: 'Tab4', content: 'Transcriptions' },
            { id: 'Tab5', content: 'DICOM' },
        ];

        //Create a DataSet (allows two way data-binding)
        var dataSet = new vis.DataSet([
            {id: 1, content: 'item 1', group: 1, start: '2013-04-20'},
            {id: 2, content: 'item 2', group: 1, start: '2014-04-14'},
            {id: 3, content: 'item 3', group: 1, start: '2015-04-18'},
            {id: 4, content: 'item 4', group: 2, start: '2016-04-16', end: '2013-04-19'},
            {id: 5, content: 'item 5', group: 2, start: '2017-04-25'},
            {id: 6, content: 'item 6', group: 2, start: '2017-04-27'}
        ]);

        var GroupByType = 
        {
            Day: 'Day',
            Week: 'Week',
            Month: 'Month',
            Quarter: 'Quarter', /* Counts display number of documents for the tab for a quarter */
            Year: 'Year' /* Counts display number of document for the tab for a year */
        };

        var documentData = [
            { Tab: 'Tab1', DaySummaries: [ 
                { Date: '2016-01-01', Count: 4 },
                { Date: '2016-02-01', Count: 9 },
                { Date: '2016-11-01', Count: 11 },
                { Date: '2017-02-01', Count: 1 },
                { Date: '2017-05-01', Count: 3 },
             ]},
            { Tab: 'Tab2', DaySummaries: [ 
                { Date: '2016-01-04', Count: 1 },
                { Date: '2016-02-02', Count: 4 },
                { Date: '2016-11-04', Count: 1 },
                { Date: '2017-02-11', Count: 10 },
                { Date: '2017-05-02', Count: 7 },
             ]},
            { Tab: 'Tab3', DaySummaries: [ 
                { Date: '2016-01-05', Count: 1 },
                { Date: '2016-02-05', Count: 1 },
                { Date: '2016-11-05', Count: 2 },
                { Date: '2017-02-05', Count: 2 },
                { Date: '2017-05-05', Count: 3 },
             ]},
        ];
        
        function formatDocumentData( groupBy, daySummaries )
        {
            switch ( groupBy )
            {
                case GroupByType.Day:
                    return daySummaries;
                case GroupByType.Week:
                    return formatWeekView( daySummaries );
                case GroupByType.Month:
                    return formatMonthView( daySummaries );
                case GroupByType.Quarter:
                    return [];
                case GroupByType.Year:
                    return formatYearView( daySummaries );
                default:
                    console.log( `Unrecognized GroupByType: ${groupBy}` );
            }
        }

        function formatWeekView( daySummaries )
        {
            return [];
        }

        function formatMonthView( daySummaries )
        {
            return [];
        }

        // function formatYearView( daySummaries )
        // {
        //     var yearSummaries = {};
        //     daySummaries.forEach( function( daySummary ) {
        //         var date = new Date(daySummary.Date);
        //         var year = date.getFullYear();
        //         var yearSummary = yearSummaries[year] || createYearSummary(year);
        //         yearSummary.count++;
        //         yearSummary.group = 1; // todo
        //         yearSummaries[year] = yearSummary;
        //     } );
        //     for (var yearSummary in yearSummaries) {
        //         if (!yearSummaries.hasOwnProperty(yearSummary)) {
        //             continue;
        //         }
        //         yearSummaries[yearSummary].content = 'Documents: ' + yearSummaries[yearSummary].count;
        //     }
        //     // Might need polyfill: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/values
        //     return Object.values( yearSummaries );
        // }

        function formatYearView2( tabSummaries )
        {
          var summaries = [];
          Object.values( tabSummaries ).forEach( function( tabSummary ) {
            var tabYearSummary = {};
            tabSummary.DaySummaries.forEach( function( daySummary ) {
              var date = new Date( daySummary.Date );              
              var year = ( date ).getUTCFullYear();
              var yearSummary = tabYearSummary[ year ] || createYearSummary( year, date, tabSummary.Tab );
              yearSummary.count += daySummary.Count;
              if (date < yearSummary.start ) {
                yearSummary.start = date;
              }
              if ( date > yearSummary.end ) {
                yearSummary.end = date;
              }
              // TODO: is it worth iterating over the array again later, to avoid formatting this string unnecessarily in intermediate iterations?
              yearSummary.content = yearSummary.count.toString();
              tabYearSummary[ year ] = yearSummary;
            });
            summaries = summaries.concat( Object.values( tabYearSummary ) );
          });
          return summaries;
        }

        function createYearSummary( year, date, tabID )
        {
            // var startDate = new Date(year, 0, 1);
            // var endDate = new Date(year, 11, 31, 23, 59, 59);
            return { start: date, end: date, group: tabID, count: 0 };
        }

        // Configuration for the Timeline
        var options = {
            width: '100%',
            height: '100%',
            margin: {
                item: 20
            },
            zoomMin: 3.154e+10, // 6.048e+8 = 1 week
            zoomMax: 3.154e+11, // 3.154e+10 = 1 year, 10 years = 3.154e+11
            end: new Date() // specify the current datetime as the end date of the timeline time axis (rather than the last item)
        };

        function onDateRangeChanged( e )
        {
            //console.log(`start: ${e.start} end: ${e.end} byUser: ${e.byUser} event: ${e.event}  `);
        }

        $(function() {
        // Create a Timeline
        // var timeline = new vis.Timeline(container, dataSet, groups, options);
        // timeline.on( 'rangechanged', onDateRangeChanged );
        //var result = new vis.DataSet( formatYearView( documentData[0].DaySummaries ) );
        var result = new vis.DataSet( formatYearView2( documentData ) );
        var timeline = new vis.Timeline( container, result, groups, options );

        // var items = new vis.DataSet([
        // {
        //     start: new Date(2016, 1, 1),
        //     end: new Date(2016, 11, 31),  // end is optional
        //     content: 'Trajectory A',
        //     group: 1
        //     // Optional: fields 'id', 'type', 'group', 'className', 'style'
        // }
        // // more items...
        // ]);
        // var timeline = new vis.Timeline(container, items, groups, options);

        });
        </script>
    </body>
</html>